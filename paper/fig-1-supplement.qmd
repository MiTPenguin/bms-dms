---
title: "`r paste(params$description, '-', params$exp_code)`"
author: "Robert Warneford-Thomson"
editor: visual
format: 
  gfm:
    toc: true
    number-sections: true
code-fold: true
execute: 
  warning: false
params:
  description: "TYK2 DMS manuscript - Fig 1 supplement"
  date: !expr format(Sys.time(), '%Y%m%d')
editor_options: 
  chunk_output_type: console
knitr:
  opts_chunk:
    fig.align: "center"
---

# I. SETUP

### Packages

```{r}
pacman::p_load(
  colorspace,
  ggbeeswarm,
  ggnewscale,
  ggh4x,
  ggpubr,
  ggsci,
  magrittr,
  paletteer,
  patchwork,
  scico,
  tidyverse
)
```

### Variables

```{r setup}
knitr::opts_chunk$set(
  echo = FALSE,
  fig.path = "./fig-1/",
  warning = FALSE,
  message = FALSE,
  dev = c("png", "pdf")
)
setwd("~/Analyses/bms-dms/paper")

cbPalette <- c( "#0072B2","#DC5E65", "#56B4E9","#E69F00",  "#009E73", "#F0E442", "pink", "#CC79A7","lightgrey", "grey", "darkgrey")

aa_order <- c("*", "P", "G", "A", "M", "V", "L", "I", "T", "S",
              "C", "Q", "N", "Y", "W", "F", "E", "D", "K", "H", "R")

source("../../dms/src/model/dms-analysis-utils.R")
```

# Functions

## compute_difference

```{r compute_difference}
compute_difference <- function(test, control, sumstats) {
    
    df1 <- sumstats %>% filter(condition == test) %>% select(-condition)
    df2 <- sumstats %>% filter(condition == control) %>% select(-condition)
    
    df <- inner_join(df1, df2,
                     by = c("pos", "chunk", "aa", "version"))
    
    new_stats <- df %>%
        mutate(log2FoldChange = log2FoldChange.x - log2FoldChange.y,
               log2StdError = sqrt(log2StdError.x^2 + log2StdError.y^2)) %>%
        select(pos, chunk, aa, log2FoldChange, log2StdError, version) %>%
        ungroup()
    
    new_stats$condition = paste0(test, " - ", control)
    
    return(new_stats)
    
}
```

## theme_pub

```{r}
theme_pub <- function(base_size = 11, base_family = "") {
  # based on https://github.com/noamross/noamtools/blob/master/R/theme_nr.R
  # start with theme_bw and modify from there!
  theme_bw(base_size = base_size, base_family = base_family) + # %+replace%
    theme(
      # grid lines
      panel.grid.major.x = element_line(colour = "#ECECEC", linewidth = 0.5, linetype = 1),
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      panel.grid.major.y = element_line(colour = "#ECECEC", linewidth = 0.5, linetype = 1),
      panel.background = element_blank(),

      # axis options
      # axis.ticks.y = element_blank(),
      axis.title.x = element_text(size = rel(1), vjust = 0.25),
      axis.title.y = element_text(size = rel(1), vjust = 0.35),
      # axis.text      = element_text(color="black", size=rel(1)),
      axis.text.y = element_text(size = rel(1), color = "black"),
      axis.text.x = element_text(angle = 45, color = "black", hjust = 1, size = rel(1)),

      # legend options
      legend.title = element_text(size = rel(1)),
      legend.key = element_rect(fill = "white"),
      legend.key.size = unit(0.02, "npc"),
      legend.text = element_text(size = rel(1)),

      # facet options
      strip.text = element_text(size = rel(1)),
      strip.background = element_blank(),

      # title options
      plot.title = element_text(size = rel(1), hjust = 0.5),
      plot.subtitle = element_text(size = rel(0.8), hjust = 0),
    )
}
```

# Load and format data

After discussing with Conor, will use 1 and 10 U/mL IFNa data from run3, and 100 U/mL IFNa from run7

```{r load-data}
#load IFNa sumstats
ifna_sumstats_run3 <- read_tsv("sumstats/TYK2-run3-combined-cleaned.sumstats.tsv", show_col_types = FALSE) %>%
    # filter(condition == "IFNalpha100_0") %>%
    mutate(aa = if_else(aa %in% c("X", "Stop", "*"), "*", aa),
           aa = factor(aa, levels = aa_order))

#compute contrasts for IFNa data
conditions <- unique(ifna_sumstats_run3$condition)
noneIdx <- which(conditions == "None_0")

ifna_run3 <- map(conditions[-noneIdx],
                         ~compute_difference(test = .,
                                            control = "None_0",
                                            sumstats = ifna_sumstats_run3)) %>%
  list_rbind() %>%
  mutate(condition = factor(condition,
                              levels = c("IFNbeta_100 - None_0",
                                         "IFNalpha_1 - None_0",
                                         "IFNalpha_10 - None_0",
                                         "IFNalpha_100 - None_0",
                                         "IFNalphaWithDrug_100 - None_0"))) %>% 
  filter(condition %in% c("IFNalpha_1 - None_0", "IFNalpha_10 - None_0", "IFNalpha_100 - None_0")) %>% 
  mutate(z_statistic = log2FoldChange / log2StdError,
           p.value = pmin(pnorm(z_statistic, mean = 0, sd = 1)*2,
                                 (1-pnorm(z_statistic, sd = 1))*2)) %>% 
  #drop IFN100
  filter(condition != "IFNalpha_100 - None_0") %>% 
  mutate(run = "run3")

#load run7 IFN100 data
ifna_run7 <- read_tsv("sumstats/TYK2-run7-combined-cleaned.sumstats.tsv", show_col_types = FALSE) %>%
    filter(condition == "IFNalpha100_0") %>%
    mutate(aa = if_else(aa %in% c("X", "Stop", "*"), "*", aa),
           aa = factor(aa, levels = aa_order)) %>% 
    mutate(run = "run7") %>% 
    rename(z_statistic = statistic)

#merge experiments
ifna_merge <- bind_rows(ifna_run3, ifna_run7) %>%
  pivot_longer(c("log2FoldChange"), names_to = "param", values_to = "param_estimate") %>% 
  select(pos, aa, chunk, param, run, param_estimate, param_se = log2StdError, condition, z_statistic, p.value) %>% 
  mutate(assay = "IFNa",
         p.adj = p.adjust(p.value, method = "BH"))
  
stability <- read_tsv("sumstats/TYK2-FLOW-flow-cleaned.midpoints.tsv", show_col_types = FALSE) %>%
    mutate(aa = if_else(aa %in% c("X", "Stop", "*"), "*", aa),
           aa = factor(aa, levels = aa_order)) %>%
  pivot_longer(c("midpoint_shift"), names_to = "param", values_to = "param_estimate") %>% 
  select(pos, aa, chunk, param, param_estimate, param_se = midpoint_shift_se, z_statistic = statistic, p.value, p.adj) %>% 
  mutate(assay = "Flow")

merge_sumstats <- bind_rows(ifna_merge, stability) %>% 
  #add annotation labels for plotting
  mutate(facet_label = case_when(assay == "Flow" ~ "Abundance",
                                 assay == "IFNa" ~ paste0("IFN\u03B1 ", str_extract(condition,
                                                                                   pattern = "IFNalpha_?(\\d+)",
                                                                                   group = 1),
                                                          " U/mL"))) %>% 
  mutate(facet_label = fct_inorder(facet_label))
```

# Figures

## Fig S1B - Flow + IFNa-1,10,100 heatmaps

```{r s1b-heatmaps, fig.width=12, fig.height=8}
merge_sumstats %>% 
  ggplot() +
  facet_grid2(rows = "facet_label",
              scales = "fixed",
              axes = "all") +
  geom_tile(aes(x = pos, y = aa, fill = z_statistic)) +
  scale_fill_scico_mid("Z statistic", limits = c(-10,2.5), palette = "vik", mid = 0, oob = scales::squish) +
  scale_x_continuous(breaks = seq(0,1000,by = 250),
                     expand = c(0, 0)) +  
  ylab("") + xlab("TYK2 Amino Acid Position") +
  ggtitle("Fig S1B") +
  theme_pub(base_size = 9) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5),
        legend.key.height = unit("0.05", "npc"),
        strip.text.y = element_text(angle = 0))
```

## Fig S1C - Barplots with LoF/GoF counts

## Fig S1D - stop effect density plots

## Fig S1E - Fiducial variant forest plot

## Fig S1F - Beeswarm with ClinVar, ESM, AlphaMissense etc
