---
title: "Octant-BMS TYK2 Manuscript Data Visuals"
author: "Nathan Abell and Conor Howard"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: github_document
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  dev = c("png", "pdf")
)

library(scico)
library(scales)
library(ggrepel)
library(ggbeeswarm)
library(janitor)
library(broom)
library(broom.mixed)
library(patchwork)
library(stringr)
library(tidyverse)

custom_theme <- theme_bw(
  base_size = 10
) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
  )
theme_set(custom_theme)

scale_fill_scico_mid <- function(..., mid = 0, alpha = NULL, begin = 0, end = 1, direction = 1, reverse = TRUE, palette = "broc") {
  force(mid)
  ggplot2::continuous_scale(
    aesthetics = "fill",
    scale_name = "gradient2",
    palette = scales::gradient_n_pal(
      colours = scico::scico(256, alpha, begin, end, direction, palette),
      values = NULL, space = "Lab"
    ),
    guide = "colourbar",
    rescaler = function(x, to = c(0, 1), from = range(x, na.rm = TRUE)) {
      scales::rescale_mid(x, to, from, mid)
    },
    ...
  )
}
```

# Common Data Processing

```{r loading}

assay3 <- read_tsv("sumstats/TYK2-run3-combined-cleaned.sumstats.tsv", show_col_types = FALSE) %>%
  select(-statistic, -p.value, -version)

treated <- assay3 %>% filter(condition != "None_0")
untreated <- assay3 %>%
  filter(condition == "None_0") %>%
  rename("log2FoldChange_Control" = "log2FoldChange",
         "log2StdError_Control" = "log2StdError") %>%
  select(-condition)

contrast_sumstats <- inner_join(treated, untreated, by = c("chunk", "pos", "aa")) %>%
  mutate(log2Contrast = log2FoldChange - log2FoldChange_Control,
         log2ContrastError = sqrt(log2StdError^2 + log2StdError_Control^2),
         statistic = log2Contrast/log2ContrastError,
         pvalue = (1 - pnorm(abs(statistic))) * 2,
         fdr = p.adjust(pvalue, method = "BH"))

write_tsv(contrast_sumstats, "sumstats/TYK2-run3-combined-cleaned.contrast.tsv")
```

# Figure 1

```{r child="fig-1.Rmd"}
```

# Figure 2

```{r child="fig-2.Rmd"}
```

# Figure 3

```{r child="fig-3.Rmd"}
```
